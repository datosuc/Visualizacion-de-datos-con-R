---
title: "Evaluación Shiny"
author: Joshua Kunst
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
  )

library(extrafont)
extrafont::loadfonts()
ggplot2::theme_set(ggplot2::theme_minimal(base_family = "Segoe UI", base_size = 15))
```

## Introducción 

La evaluación constará en realizar una aplicación en shiny en la cual se
medirán las siguientes habilidades:

1. Instalar paquetes y cargarlos.
1. Uso de funciones y parámetros.
1. Copiar código y reusarlo a favor de la creación de la aplicación.
1. Creación de `ui` y `server` básico.
1. Utilización de otros inputs y outputs.
1. Publicar usando el servicio shinyapps.io

Deberá crear una aplicación para mostrar el evolutivo del precio de la
acción de una empresa.

## Recursos

Slides de las presentaciones:

- Presentacion #1 https://datosuc.github.io/Visualizacion-de-datos-con-R/#1
- Presentacion #2 https://datosuc.github.io/Visualizacion-de-datos-con-R/index2.html

En cada una de las presentaciones existen links a contenido más específico como por ejemplo:

- https://shiny.rstudio.com/tutorial/
- https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/
- https://github.com/rstudio/cheatsheets/raw/master/shiny.pdf
- https://github.com/rstudio/cheatsheets/raw/master/translations/spanish/shiny_Spanish.pdf



## Paquetes a utilizar

Utilizaremos los paquetes `tidyverse` y `jsonlite` por lo que tendrá que instalarlos
en caso de que su sesión se RStudio no lo tenga y luego cargarlos:

```{r}
library(tidyverse)
library(jsonlite)
```

## Función auxiliar 

La función la cual el corazón de la app es la siguiente:

```{r}
obtener_indicadores <- function(empresa = "FALABELLA") {

  message("Descargando: ", empresa)
  
  url <- stringr::str_c(
    "https://www.elmercurio.com/inversiones/json/json.aspx?categoria=",
    empresa,
    "&time=10&indicador=2"
  )
  
  d <- jsonlite::read_json(url)$Data
  
  df <- d %>% 
    stringr::str_split(";") %>% 
    dplyr::first() %>% 
    readr::read_delim(delim = ",", col_names = c("fecha", "precio", "vol"))
  
  df <- df %>% 
    mutate(
      fecha = lubridate::ymd_hms(fecha),
      anio = lubridate::year(fecha)
      )
  
  df
  
}
```

El modo de uso es:

```{r}
obtener_indicadores("FALABELLA")
```

Por favor, notar el tipo y la información de cada columna. Ahora, lo que podríamos hacer es:

```{r}
data <- obtener_indicadores("FALABELLA")

plot <- ggplot(data) +
  geom_line(aes(fecha, precio), color = "#2196f3")

plot
```

O mejor un gráfico interactivo a costo (casi) 0!:

```{r}
library(plotly)
ggplotly(plot)
```

## Empresas

Como mencionamos al comienzo, la aplicación tiene como finalidad mostrar la evolución
del precio de la acción de la empresa seleccionada. La lista de posibles empresas
se deja a continuación para su uso:

```{r, echo=FALSE, include=FALSE}
urlr <- "https://www.rankia.cl/blog/analisis-ipsa/3229498-que-empresas-forman-parte-ipsa-2018"
empresas <- xml2::read_html(urlr) %>% 
  rvest::html_nodes("td") %>% 
  rvest::html_text()

empresas <- empresas[seq(1, length(empresas), by = 2)]

empresas <- empresas %>% 
  setdiff(c("ÍNDICES", "SALE"))

dput(empresas)
```

```{r}
empresas <- c("NUEVAPOLAR", "SMU", "BESALCO", "COPEC", "FALABELLA", "BSANTANDER", 
"CMPC", "CHILE", "SQM-B", "ENELAM", "CENCOSUD", "BCI", "LTM", 
"ENELCHILE", "SM-CHILE B", "CCU", "PARAUCO", "ITAUCORP", "AGUAS-A", 
"COLBUN", "ENTEL", "ECL", "CONCHATORO", "RIPLEY", "AESGENER", 
"ANDINA-B", "SONDA", "CAP", "ILC", "SALFACORP", "SECURITY", "VAPORES", 
"ENELGXCH", "ANTARCHILE", "BANMEDICA", "EMBONOR-B", "FORUS", 
"IAM", "MASISA", "ORO BLANCO", "SK", "SMSAAM")
```

## Primer paso

Se le solicita que la aplicación tenga la siguiente estructura:

![](https://i.imgur.com/EjO9rbv.png)


## Paso Final

La aplicación anterior la debe mejorar con lo siguiente:

- Agregar inputs para poder seleccionar rango de años a graficar
- Crear un ouput que mencione el valor promedio de la acción en
el periodo seleccionado
- Hacer que el gráfico sea interactivo, como en el ejemplo.








